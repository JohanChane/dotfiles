#!/usr/bin/env python3
import os
import sys
import argparse
import subprocess
import shutil
import platform
from datetime import datetime, timedelta

# é»˜è®¤å¿½ç•¥çš„æ–‡ä»¶å’Œç›®å½•
DEFAULT_IGNORES = {
    '.git', '.svn', '.hg', '.DS_Store', '.vscode', '.idea',
    '__pycache__', 'node_modules', 'venv', '.env',
    '*.pyc', '*.pyo', '*.so', '*.dll', '.exe',
    '*.log', '.tmp', '.temp', 'dist', 'build',
    'package-lock.json', 'yarn.lock',
    'coverage', '.coverage', 'htmlcov', '.pytest_cache',
    'target', '.cache'
}

def get_system_info():
    """è·å–ç³»ç»Ÿä¿¡æ¯"""
    system = platform.system()
    release = platform.release()
    version = platform.version()
    architecture = platform.architecture()[0]
    machine = platform.machine()

    # æ›´è¯¦ç»†çš„ç³»ç»Ÿè¯†åˆ«
    if system == "Windows":
        system_detail = f"Windows {release} ({version})"
    elif system == "Darwin":
        # macOS ç³»ç»Ÿ
        mac_ver = platform.mac_ver()[0]
        system_detail = f"macOS {mac_ver} ({system} {release})"
    elif system == "Linux":
        # å°è¯•è·å– Linux å‘è¡Œç‰ˆä¿¡æ¯
        try:
            import distro
            distro_name = distro.name(pretty=True)
            system_detail = f"{distro_name} ({system} {release})"
        except ImportError:
            system_detail = f"Linux {release}"
    else:
        system_detail = f"{system} {release}"

    return {
        'system': system,
        'system_detail': system_detail,
        'architecture': architecture,
        'machine': machine,
        'python_version': platform.python_version()
    }

def is_git_repository(project_dir):
    """æ£€æŸ¥ç›®å½•æ˜¯å¦æ˜¯ Git ä»“åº“"""
    git_dir = os.path.join(project_dir, '.git')
    return os.path.exists(git_dir) and os.path.isdir(git_dir)

def get_git_log(project_dir, max_entries=50):
    """è·å– Git æäº¤æ—¥å¿—"""
    try:
        result = subprocess.run(
            ['git', 'log', f'--max-count={max_entries}', '--oneline', '--decorate'],
            cwd=project_dir,
            capture_output=True, text=True, timeout=30
        )
        if result.returncode == 0:
            return result.stdout.strip()
        else:
            return f"<è·å– Git æ—¥å¿—å¤±è´¥: {result.stderr.strip()}>"
    except subprocess.TimeoutExpired:
        return "<è·å– Git æ—¥å¿—è¶…æ—¶>"
    except Exception as e:
        return f"<è·å– Git æ—¥å¿—å‡ºé”™: {e}>"

def get_git_diff(project_dir):
    """è·å– Git å·¥ä½œåŒºå˜æ›´"""
    try:
        # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´
        status_result = subprocess.run(
            ['git', 'status', '--porcelain'],
            cwd=project_dir,
            capture_output=True, text=True, timeout=10
        )

        if status_result.returncode != 0 or not status_result.stdout.strip():
            return "<æ— æœªæäº¤çš„å˜æ›´>"

        # è·å–è¯¦ç»†çš„ diff
        diff_result = subprocess.run(
            ['git', 'diff', '--no-color'],
            cwd=project_dir,
            capture_output=True, text=True, timeout=30
        )

        if diff_result.returncode == 0:
            return diff_result.stdout.strip()
        else:
            return f"<è·å– Git å·®å¼‚å¤±è´¥: {diff_result.stderr.strip()}>"

    except subprocess.TimeoutExpired:
        return "<è·å– Git å·®å¼‚è¶…æ—¶>"
    except Exception as e:
        return f"<è·å– Git å·®å¼‚å‡ºé”™: {e}>"

def get_git_branch_info(project_dir):
    """è·å– Git åˆ†æ”¯ä¿¡æ¯"""
    try:
        # è·å–å½“å‰åˆ†æ”¯
        branch_result = subprocess.run(
            ['git', 'branch', '--show-current'],
            cwd=project_dir,
            capture_output=True, text=True, timeout=10
        )

        # è·å–è¿œç¨‹ä¿¡æ¯
        remote_result = subprocess.run(
            ['git', 'remote', '-v'],
            cwd=project_dir,
            capture_output=True, text=True, timeout=10
        )

        branch_info = []
        if branch_result.returncode == 0 and branch_result.stdout.strip():
            branch_info.append(f"å½“å‰åˆ†æ”¯: {branch_result.stdout.strip()}")

        if remote_result.returncode == 0 and remote_result.stdout.strip():
            branch_info.append("è¿œç¨‹ä»“åº“:")
            branch_info.extend([f"  {line}" for line in remote_result.stdout.strip().split('\n')])

        return "\n".join(branch_info) if branch_info else "<æ— åˆ†æ”¯ä¿¡æ¯>"

    except Exception as e:
        return f"<è·å–åˆ†æ”¯ä¿¡æ¯å‡ºé”™: {e}>"

def has_file_command():
    """æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æœ‰ file å‘½ä»¤"""
    return shutil.which('file') is not None

def is_text_file_by_file_command(filepath):
    """ä½¿ç”¨ç³»ç»Ÿçš„ file å‘½ä»¤åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡æœ¬æ–‡ä»¶"""
    try:
        result = subprocess.run(
            ['file', '--mime-type', '-b', filepath],
            capture_output=True, text=True, timeout=5
        )
        if result.returncode == 0:
            mime_type = result.stdout.strip()
            return (mime_type.startswith('text/') or
                   mime_type in ['application/xml', 'application/json',
                               'application/x-sh', 'application/x-python'])
    except (subprocess.TimeoutExpired, subprocess.SubprocessError, OSError):
        pass
    return False

def is_text_file_fallback(filepath):
    """å›é€€çš„æ–‡æœ¬æ–‡ä»¶æ£€æµ‹æ–¹æ³•"""
    try:
        with open(filepath, 'rb') as f:
            chunk = f.read(8192)

            if not chunk:
                return True
            if b'\0' in chunk:
                return False

            text_chars = bytearray({7, 8, 9, 10, 12, 13, 27})
            text_chars.extend(range(32, 127))
            text_chars = set(text_chars)

            non_text_count = sum(1 for byte in chunk if byte not in text_chars)
            return non_text_count / len(chunk) <= 0.3

    except (IOError, OSError):
        return False

def is_text_file(filepath):
    """åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸ºæ–‡æœ¬æ–‡ä»¶"""
    if has_file_command():
        return is_text_file_by_file_command(filepath)
    else:
        return is_text_file_fallback(filepath)

def get_file_modification_time(filepath):
    """è·å–æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´"""
    try:
        timestamp = os.path.getmtime(filepath)
        mod_time = datetime.fromtimestamp(timestamp)
        return mod_time.strftime("%Y-%m-%d %H:%M:%S")
    except (OSError, ValueError):
        return "æœªçŸ¥æ—¶é—´"

def should_ignore(path, custom_ignore_file=None):
    """æ£€æŸ¥æ–‡ä»¶æˆ–ç›®å½•æ˜¯å¦åº”è¯¥è¢«å¿½ç•¥"""
    basename = os.path.basename(path)

    for ignore_pattern in DEFAULT_IGNORES:
        if ignore_pattern.startswith('*'):
            if basename.endswith(ignore_pattern[1:]):
                return True
        elif basename == ignore_pattern:
            return True

    if custom_ignore_file and os.path.exists(custom_ignore_file):
        try:
            with open(custom_ignore_file, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#') and basename == line:
                        return True
        except:
            pass

    try:
        if os.path.isfile(path) and os.path.getsize(path) > 1024 * 1024:
            return True
    except:
        pass

    return False

def read_file_content(filepath):
    """è¯»å–æ–‡ä»¶å†…å®¹ï¼Œå¤„ç†ç¼–ç é—®é¢˜"""
    if not is_text_file(filepath):
        return f"<éæ–‡æœ¬æ–‡ä»¶å·²è·³è¿‡: {filepath}>"

    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return f.read()
    except UnicodeDecodeError:
        try:
            with open(filepath, 'r', encoding=sys.getdefaultencoding()) as f:
                return f.read()
        except UnicodeDecodeError:
            try:
                with open(filepath, 'r', encoding='latin-1') as f:
                    return f.read()
            except Exception as e:
                return f"<æ— æ³•è¯»å–æ–‡ä»¶: {filepath} - {e}>"
    except Exception as e:
        return f"<è¯»å–æ–‡ä»¶å‡ºé”™: {e}>"

def generate_ai_prompt_header(project_dir, file_count, total_size, ignored_count, binary_count, is_git_repo=False, modified_since=None):
    """ç”ŸæˆAIæç¤ºè¯å¤´éƒ¨"""
    abs_path = os.path.abspath(project_dir)
    current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # è·å–ç³»ç»Ÿä¿¡æ¯
    system_info = get_system_info()

    header = [
        "ğŸ¤– AI é¡¹ç›®åˆ†ææç¤ºè¯",
        "=" * 60,
        "",
        "ğŸ“‹ æŒ‡ä»¤è¯´æ˜:",
        "ä½ æ˜¯ä¸€ä¸ªèµ„æ·±çš„è½¯ä»¶å¼€å‘åŠ©æ‰‹ã€‚ä»¥ä¸‹æ˜¯ç”¨æˆ·é¡¹ç›®çš„å®Œæ•´ä»£ç ç»“æ„ã€‚",
        "è¯·ä»”ç»†åˆ†æè¿™ä¸ªé¡¹ç›®ï¼Œç†è§£å…¶æ¶æ„ã€æŠ€æœ¯å’ŒåŠŸèƒ½ï¼Œå‡†å¤‡å›ç­”ç”¨æˆ·çš„å„ç§é—®é¢˜ã€‚",
        "",
        "ğŸ¯ ä½ çš„ä»»åŠ¡:",
        "1. ç†è§£é¡¹ç›®çš„æ•´ä½“ç»“æ„å’Œæ¶æ„è®¾è®¡",
        "2. è¯†åˆ«ä½¿ç”¨çš„æŠ€æœ¯æ ˆã€æ¡†æ¶å’Œåº“",
        "3. åˆ†æä»£ç è´¨é‡å’Œæœ€ä½³å®è·µ",
        "4. å‡†å¤‡å›ç­”å…³äºåŠŸèƒ½ã€bugä¿®å¤ã€ä»£ç æ”¹è¿›ç­‰é—®é¢˜",
        "5. æä¾›æŠ€æœ¯å»ºè®®å’Œä¼˜åŒ–æ–¹æ¡ˆ",
        "",
        "ğŸ’¡ ç”¨æˆ·å¯èƒ½ä¼šè¯¢é—®:",
        "- ä»£ç åŠŸèƒ½è§£é‡Šå’Œä¿®æ”¹å»ºè®®",
        "- Bug æ’æŸ¥å’Œä¿®å¤æ–¹æ¡ˆ",
        "- æ–°åŠŸèƒ½å®ç°æ€è·¯",
        "- ä»£ç é‡æ„å’Œä¼˜åŒ–å»ºè®®",
        "- æŠ€æœ¯é€‰å‹å’Œæ¶æ„è®¾è®¡é—®é¢˜",
        "- éƒ¨ç½²å’Œé…ç½®é—®é¢˜",
        "- ç³»ç»Ÿç›¸å…³é—®é¢˜å’Œå…¼å®¹æ€§",
        "",
        "ğŸ“Š é¡¹ç›®æ¦‚è§ˆ:",
        f"- é¡¹ç›®è·¯å¾„: {abs_path}",
        f"- åˆ†ææ—¶é—´: {current_time}",
        f"- æ“ä½œç³»ç»Ÿ: {system_info['system_detail']}",
        f"- ç³»ç»Ÿæ¶æ„: {system_info['architecture']} ({system_info['machine']})",
        f"- Python ç‰ˆæœ¬: {system_info['python_version']}",
        f"- Git ä»“åº“: {'æ˜¯' if is_git_repo else 'å¦'}",
        f"- åˆ†ææ–‡ä»¶: {file_count} ä¸ª",
        f"- å¿½ç•¥æ–‡ä»¶: {ignored_count} ä¸ª",
        f"- è·³è¿‡éæ–‡æœ¬æ–‡ä»¶: {binary_count} ä¸ª",
        f"- æ€»ä»£ç å¤§å°: {total_size} å­—èŠ‚ ({total_size/1024:.1f} KB)",
        f"- æ–‡ä»¶æ£€æµ‹æ–¹æ³•: {'file å‘½ä»¤' if has_file_command() else 'å›é€€æ–¹æ³•'}",
    ]

    # æ·»åŠ æ—¶é—´è¿‡æ»¤ä¿¡æ¯
    if modified_since is not None:
        header.append(f"- æ—¶é—´è¿‡æ»¤: æœ€è¿‘ {modified_since} ç§’å†…ä¿®æ”¹çš„æ–‡ä»¶")

    header.extend([
        "",
        "ğŸ“ é¡¹ç›®æ–‡ä»¶è¯¦æƒ…:",
        "=" * 60,
        ""
    ])

    return "\n".join(header)

def generate_git_section(project_dir, git_diff_only=False):
    """ç”Ÿæˆ Git ç›¸å…³ä¿¡æ¯éƒ¨åˆ†ï¼ˆMarkdown æ ¼å¼ï¼‰
    
    Args:
        project_dir: é¡¹ç›®ç›®å½•
        git_diff_only: å¦‚æœä¸º Trueï¼ŒåªåŒ…å« Git diff ä¿¡æ¯
    """
    if not is_git_repository(project_dir):
        return ""

    git_section = [
        "\n" + "=" * 60,
        "## ğŸ”° Git ä»“åº“ä¿¡æ¯",
        "=" * 60,
        ""
    ]

    if not git_diff_only:
        # åˆ†æ”¯ä¿¡æ¯
        branch_info = get_git_branch_info(project_dir)
        git_section.extend([
            "### ğŸŒ¿ åˆ†æ”¯ä¿¡æ¯",
            "ç”Ÿæˆå‘½ä»¤: `git branch --show-current` å’Œ `git remote -v`",
            "```",
            branch_info,
            "```",
            ""
        ])

        # æäº¤æ—¥å¿—
        git_log = get_git_log(project_dir)
        git_section.extend([
            "### ğŸ“œ æœ€è¿‘æäº¤è®°å½•",
            "ç”Ÿæˆå‘½ä»¤: `git log --max-count=50 --oneline --decorate`",
            "```",
            git_log,
            "```",
            ""
        ])

    # å·¥ä½œåŒºå˜æ›´ï¼ˆæ€»æ˜¯åŒ…å«ï¼‰
    git_diff = get_git_diff(project_dir)
    git_section.extend([
        "### ğŸ“ æœªæäº¤çš„å˜æ›´",
        "ç”Ÿæˆå‘½ä»¤: `git diff --no-color`",
        "```diff",
        git_diff,
        "```",
        ""
    ])

    return "\n".join(git_section)

def get_files_modified_since(project_dir, seconds_ago):
    """è·å–æŒ‡å®šæ—¶é—´èŒƒå›´å†…ä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼ˆåŸºäºæ–‡ä»¶ç³»ç»Ÿæ—¶é—´ï¼‰"""
    modified_files = set()
    cutoff_time = datetime.now() - timedelta(seconds=seconds_ago)

    print(f"ğŸ” æ—¶é—´è¿‡æ»¤: æŸ¥æ‰¾åœ¨ {cutoff_time.strftime('%Y-%m-%d %H:%M:%S')} ä¹‹åä¿®æ”¹çš„æ–‡ä»¶")

    for root, dirs, files in os.walk(project_dir):
        # åº”ç”¨å¿½ç•¥è§„åˆ™åˆ°ç›®å½•
        dirs[:] = [d for d in dirs if not should_ignore(os.path.join(root, d), None)]

        for file in files:
            filepath = os.path.join(root, file)
            rel_path = os.path.relpath(filepath, project_dir)

            if should_ignore(filepath, None):
                continue

            try:
                mod_time = datetime.fromtimestamp(os.path.getmtime(filepath))
                if mod_time >= cutoff_time:
                    modified_files.add(rel_path)
                    print(f"  âœ… æ‰¾åˆ°ä¿®æ”¹æ–‡ä»¶: {rel_path}")
            except (OSError, ValueError):
                continue

    return modified_files

def generate_project_prompt(project_dir, custom_ignore_file=None, modified_since=None, git_diff_only=False):
    """ç”Ÿæˆé¡¹ç›®æç¤ºæ–‡æœ¬"""
    output = []
    abs_path = os.path.abspath(project_dir)

    file_count = 0
    total_size = 0
    ignored_count = 0
    binary_count = 0
    file_entries = []

    # å¦‚æœæŒ‡å®šäº†æ—¶é—´è¿‡æ»¤ï¼Œè·å–ä¿®æ”¹è¿‡çš„æ–‡ä»¶åˆ—è¡¨
    modified_files = set()

    if modified_since is not None:
        print(f"â° æ­£åœ¨æŸ¥æ‰¾æœ€è¿‘ {modified_since} ç§’å†…ä¿®æ”¹çš„æ–‡ä»¶...")
        modified_files = get_files_modified_since(project_dir, modified_since)
        print(f"ğŸ“ æ‰¾åˆ° {len(modified_files)} ä¸ªåœ¨æœ€è¿‘ {modified_since} ç§’å†…ä¿®æ”¹çš„æ–‡ä»¶")

    # éå†æ–‡ä»¶
    for root, dirs, files in os.walk(project_dir):
        dirs[:] = [d for d in dirs if not should_ignore(os.path.join(root, d), custom_ignore_file)]

        for file in files:
            filepath = os.path.join(root, file)
            rel_path = os.path.relpath(filepath, project_dir)

            if should_ignore(filepath, custom_ignore_file):
                ignored_count += 1
                continue

            # å¦‚æœå¯ç”¨äº†æ—¶é—´è¿‡æ»¤ï¼Œåªå¤„ç†ä¿®æ”¹è¿‡çš„æ–‡ä»¶
            if modified_since is not None and rel_path not in modified_files:
                continue

            if not is_text_file(filepath):
                binary_count += 1
                continue

            try:
                file_size = os.path.getsize(filepath)
                total_size += file_size
                mod_time = get_file_modification_time(filepath)

                file_entries.append({
                    'path': rel_path,
                    'size': file_size,
                    'mod_time': mod_time,
                    'content': None
                })
                file_count += 1
            except:
                continue

    # æ£€æŸ¥æ˜¯å¦æ˜¯ Git ä»“åº“
    is_git_repo = is_git_repository(project_dir)

    # ç”ŸæˆAIæç¤ºè¯å¤´éƒ¨
    output.append(generate_ai_prompt_header(project_dir, file_count, total_size, ignored_count, binary_count, is_git_repo, modified_since))

    # å¦‚æœæ˜¯ Git ä»“åº“ï¼Œæ·»åŠ  Git ä¿¡æ¯
    if is_git_repo:
        output.append(generate_git_section(project_dir, git_diff_only))

    # ç¬¬äºŒééå†ï¼šè¯»å–æ–‡ä»¶å†…å®¹
    for entry in file_entries:
        filepath = os.path.join(project_dir, entry['path'])
        content = read_file_content(filepath)

        if content.startswith("<éæ–‡æœ¬æ–‡ä»¶å·²è·³è¿‡:"):
            binary_count += 1
            file_count -= 1
            continue

        # æ·»åŠ ä¿®æ”¹æ—¶é—´æ ‡è®°
        output.append(f"\n## æ–‡ä»¶: {entry['path']}")
        output.append(f"ğŸ“ å¤§å°: {entry['size']} å­—èŠ‚")
        output.append(f"ğŸ“… ä¿®æ”¹æ—¶é—´: {entry['mod_time']}")
        if modified_since:
            output.append(f"ğŸ•’ æœ€è¿‘ä¿®æ”¹: æ˜¯ (åœ¨ {modified_since} ç§’å†…)")
        output.append("```")
        output.append(content)
        output.append("```")
        output.append("-" * 50)

    # æ›´æ–°æ€»ç»“éƒ¨åˆ†
    summary = [
        "",
        "=" * 60,
        ""
    ]

    if modified_since:
        if file_count == 0:
            summary.extend([
                f"âš ï¸  æ³¨æ„: åœ¨æœ€è¿‘ {modified_since} ç§’å†…æ²¡æœ‰æ‰¾åˆ°ä¿®æ”¹çš„æ–‡æœ¬æ–‡ä»¶",
                "è¿™å¯èƒ½æ˜¯å› ä¸º:",
                "  â€¢ æœ€è¿‘æ²¡æœ‰ä¿®æ”¹ä»»ä½•ä»£ç æ–‡ä»¶",
                "  â€¢ ä¿®æ”¹çš„æ–‡ä»¶è¢«å¿½ç•¥è§„åˆ™è¿‡æ»¤äº†",
                "  â€¢ ä¿®æ”¹çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶æˆ–éæ–‡æœ¬æ–‡ä»¶",
                "  â€¢ æ–‡ä»¶ç³»ç»Ÿæ—¶é—´ä¸å‡†ç¡®",
                "",
                "å»ºè®®ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡æ–°è¿è¡Œä»¥æŸ¥çœ‹è¯¦ç»†è°ƒè¯•ä¿¡æ¯:",
                f"  python {sys.argv[0]} --modified-since {modified_since}",
                ""
            ])
        else:
            summary.extend([
                f"ğŸ¯ æ³¨æ„: æœ¬æ¬¡åˆ†æä¸“æ³¨äºæœ€è¿‘ {modified_since} ç§’å†…ä¿®æ”¹çš„ {file_count} ä¸ªæ–‡ä»¶",
                "è¿™æœ‰åŠ©äºèšç„¦äºæœ€è¿‘çš„ä»£ç å˜æ›´å’Œå½“å‰å¼€å‘ä»»åŠ¡",
                ""
            ])

    summary.extend([
        "åŸºäºä»¥ä¸Šä»£ç ï¼Œä½ æ˜¯å¦å·²ç»å…¨é¢äº†è§£äº†è¿™ä¸ªé¡¹ç›®?",
        "å¯ä»¥éšæ—¶å‘ä½ æé—®å…³äºä»¥ä¸‹çš„é—®é¢˜:",
        "  â€¢ ä»£ç åŠŸèƒ½å’Œé€»è¾‘è§£é‡Š",
        "  â€¢ Bug æ’æŸ¥å’Œä¿®å¤",
        "  â€¢ æ–°åŠŸèƒ½å¼€å‘å»ºè®®",
        "  â€¢ ä»£ç é‡æ„å’Œä¼˜åŒ–",
        "  â€¢ æ¶æ„è®¾è®¡æ”¹è¿›",
        "  â€¢ æŠ€æœ¯æ ˆç›¸å…³é—®é¢˜",
        "  â€¢ éƒ¨ç½²å’Œé…ç½®é—®é¢˜",
        "  â€¢ ç³»ç»Ÿå…¼å®¹æ€§é—®é¢˜",
        "",
        "ä¸ºäº†ä½¿æˆ‘æ›´åŠ æ–¹ä¾¿åœ°ä¿®æ”¹æ–‡ä»¶:",
        "  â€¢ å¦‚æœæ˜¯è¾“å‡ºäº†æ•´ä¸ªæ–‡ä»¶çš„å†…å®¹, ä½ å°±æç¤ºè¦†ç›–æ•´ä¸ªæ–‡ä»¶",
        "  â€¢ å¦‚æœä¸æ˜¯è¦ä¿®æ”¹æ•´ä¸ªæ–‡ä»¶çš„å†…å®¹, ä½ å°±æç¤ºæ›´æ–°æ–‡ä»¶çš„éƒ¨åˆ†å†…å®¹",
        "  â€¢ å¦‚æœä¸€ä¸ªæ–‡ä»¶æˆ–å‡½æ•°å¾ˆé•¿æ—¶, ä½ å°±æç¤ºä¿®æ”¹äº†å“ªäº›å†…å®¹, å‰åæœ‰æ²¡ä¿®æ”¹çš„å†…å®¹è®©æˆ‘æ–¹ä¾¿å®šä½",
        "",
        "ä½ æœ‰ä»€ä¹ˆä¸ç¡®å®šæˆ–è€…æ­§ä¹‰çš„æ—¶å€™è¦å‘æˆ‘ç¡®å®šå†äº§å‡º",
        "ä½ æ˜¯å¦å‡†å¤‡å¥½äº†?",
        ""
    ])

    output.extend(summary)

    return "\n".join(output)

def main():
    parser = argparse.ArgumentParser(
        description='ç”Ÿæˆé¡¹ç›®æ–‡ä»¶ç»“æ„æç¤ºç»™AI',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=f'''
ä½¿ç”¨ç¤ºä¾‹:
  {sys.argv[0]}                    # åˆ†æå½“å‰ç›®å½•ï¼Œè¾“å‡ºåˆ°ç»ˆç«¯
  {sys.argv[0]} /path/to/project   # åˆ†ææŒ‡å®šç›®å½•
  {sys.argv[0]} --output prompt.txt        # ä¿å­˜åˆ°æ–‡ä»¶
  {sys.argv[0]} --modified-since 3600      # åªåˆ†ææœ€è¿‘1å°æ—¶å†…ä¿®æ”¹çš„æ–‡ä»¶
  {sys.argv[0]} --modified-since 1800 --output recent_changes.txt  # æœ€è¿‘30åˆ†é’Ÿä¿®æ”¹çš„æ–‡ä»¶
  {sys.argv[0]} --git-diff                # åŒ…å« Git diff ä¿¡æ¯

æ—¶é—´è¿‡æ»¤é€‰é¡¹:
  --modified-since 3600    # æœ€è¿‘1å°æ—¶ (3600ç§’)
  --modified-since 1800    # æœ€è¿‘30åˆ†é’Ÿ
  --modified-since 300     # æœ€è¿‘5åˆ†é’Ÿ

Git é€‰é¡¹:
  --git-diff               # åŒ…å« Git diff ä¿¡æ¯ï¼ˆåŒæ—¶åŒ…å«åˆ†æ”¯å’Œæäº¤å†å²ï¼‰

é»˜è®¤å¿½ç•¥çš„æ–‡ä»¶/ç›®å½•:
  {', '.join(sorted(DEFAULT_IGNORES))}
        '''
    )

    parser.add_argument('project_dir', nargs='?', default='.',
                       help='é¡¹ç›®ç›®å½• (é»˜è®¤: å½“å‰ç›®å½•)')
    parser.add_argument('--ignore-file', '-i',
                       help='è‡ªå®šä¹‰ ignore æ–‡ä»¶è·¯å¾„ (å¦‚ .gitignore)')
    parser.add_argument('--output', '-o',
                       help='è¾“å‡ºåˆ°æ–‡ä»¶')
    parser.add_argument('--force-fallback', action='store_true',
                       help='å¼ºåˆ¶ä½¿ç”¨å›é€€æ–¹æ³•ï¼Œä¸ä½¿ç”¨ file å‘½ä»¤')
    parser.add_argument('--git-diff', action='store_true',
                       help='åŒ…å« Git diff ä¿¡æ¯ï¼ˆåŒæ—¶åŒ…å«åˆ†æ”¯å’Œæäº¤å†å²ï¼‰')
    # æ–°å¢æ—¶é—´è¿‡æ»¤å‚æ•°
    parser.add_argument('--modified-since', type=int, metavar='SECONDS',
                       help='åªåˆ†ææœ€è¿‘æŒ‡å®šç§’æ•°å†…ä¿®æ”¹è¿‡çš„æ–‡ä»¶')

    args = parser.parse_args()

    project_dir = args.project_dir

    if not os.path.exists(project_dir):
        print(f"é”™è¯¯: ç›®å½•ä¸å­˜åœ¨: {project_dir}")
        sys.exit(1)

    if not os.path.isdir(project_dir):
        print(f"é”™è¯¯: ä¸æ˜¯ç›®å½•: {project_dir}")
        sys.exit(1)

    if args.ignore_file and not os.path.exists(args.ignore_file):
        print(f"è­¦å‘Š: å¿½ç•¥æ–‡ä»¶ä¸å­˜åœ¨: {args.ignore_file}")
        args.ignore_file = None

    if args.force_fallback:
        global is_text_file
        is_text_file = is_text_file_fallback
        print("âš ï¸  å¼ºåˆ¶ä½¿ç”¨å›é€€æ£€æµ‹æ–¹æ³•")

    # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    system_info = get_system_info()
    print(f"ğŸ’» è¿è¡Œç¯å¢ƒ: {system_info['system_detail']}")
    print(f"ğŸ—ï¸  ç³»ç»Ÿæ¶æ„: {system_info['architecture']} ({system_info['machine']})")
    print(f"ğŸ Python ç‰ˆæœ¬: {system_info['python_version']}")

    # æ˜¾ç¤ºæ—¶é—´è¿‡æ»¤ä¿¡æ¯
    if args.modified_since:
        time_desc = ""
        if args.modified_since < 60:
            time_desc = f"({args.modified_since}ç§’)"
        elif args.modified_since < 3600:
            time_desc = f"({args.modified_since//60}åˆ†é’Ÿ)"
        else:
            time_desc = f"({args.modified_since//3600}å°æ—¶)"
        print(f"â° æ—¶é—´è¿‡æ»¤: åªåˆ†ææœ€è¿‘ {args.modified_since} ç§’å†…ä¿®æ”¹çš„æ–‡ä»¶ {time_desc}")

    # æ˜¾ç¤º Git ä¿¡æ¯
    if args.git_diff:
        print("ğŸ”€ Git ä¿¡æ¯: åŒ…å«åˆ†æ”¯ä¿¡æ¯ã€æäº¤å†å²å’Œæœªæäº¤çš„å˜æ›´")

    print("ğŸ” æ­£åœ¨åˆ†æé¡¹ç›®ç»“æ„...")

    prompt = generate_project_prompt(project_dir, args.ignore_file, args.modified_since, args.git_diff)

    if args.output:
        try:
            with open(args.output, 'w', encoding='utf-8') as f:
                f.write(prompt)
            print(f"ğŸ’¾ é¡¹ç›®æç¤ºå·²ä¿å­˜åˆ°: {args.output}")
        except Exception as e:
            print(f"âŒ ä¿å­˜æ–‡ä»¶å¤±è´¥: {e}")
            sys.exit(1)
    else:
        print(prompt)
        return

    if args.output:
        print("\nğŸ“Š é¢„è§ˆ (å‰20è¡Œ):")
        print("=" * 50)
        lines = prompt.split('\n')
        for i, line in enumerate(lines[:20]):
            print(line)
        if len(lines) > 20:
            print(f"... (è¿˜æœ‰ {len(lines) - 20} è¡Œ)")

        print(f"\nğŸ“ˆ ç»Ÿè®¡: æ€»å­—ç¬¦æ•°: {len(prompt)}")
        if args.modified_since:
            file_count = len([l for l in lines if l.startswith('## æ–‡ä»¶:')])
            print(f"ğŸ¯ ä¸“æ³¨äºæœ€è¿‘ä¿®æ”¹çš„ {file_count} ä¸ªæ–‡ä»¶")
        print("âœ… å®Œæˆ! ç°åœ¨å¯ä»¥å°†æ–‡ä»¶å†…å®¹æä¾›ç»™ AI åŠ©æ‰‹è¿›è¡Œåˆ†æ")

if __name__ == "__main__":
    main()
